{% extends "base.html" %}

<!------------Manage Groups Title----------->
{% block title %}Manage Groups - Blog App{% endblock %}

<!------------Style link-------------------->
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manage_groups.css') }}">
{% endblock %}

<!------------Content Blocks---------------->
{% block content %}
<div class="gradient-admin">
    <!-- Background Gradients -->
    <div class="gradient-left"></div>
    <div class="gradient-right"></div>
    
    <!-- Header -->
    <div class="simple-header">
        <h1>Group Manager</h1>
        <p>Organize your blog posts into groups</p>
        <a href="{{ url_for('admin') }}" class="back-to-admin-btn">
            ‚Üê Back to Admin
        </a>
    </div>

    <!-- Create New Group Form -->
    <div class="form-card">
        <h2 class="card-title">Create New Group</h2>
        <form method="POST" action="{{ url_for('create_group') }}" class="clean-form">
            <div class="input-group">
                <input type="text" id="group_name" name="group_name" class="clean-input" placeholder=" " required>
                <label for="group_name" class="input-label">Group Name</label>
            </div>
            <div class="input-group">
                <textarea id="group_description" name="group_description" rows="2" class="clean-textarea" placeholder=" "></textarea>
                <label for="group_description" class="input-label">Group Description (Optional)</label>
            </div>
            <button type="submit" class="submit-btn">
                <span>Create Group</span>
            </button>
        </form>
    </div>

    <!-- Quick Add Posts to Groups Section -->
    {% if blogs and groups %}
    <div class="bulk-section">
        <div class="section-header">
            <h2>Quick Add Posts to Groups</h2>
            <span class="post-count">{{ blogs|length }} posts available</span>
        </div>
        
        <div class="bulk-interface">
            <!-- Search and Selection Area -->
            <div class="selection-area">
                <div class="search-controls">
                    <input type="text" id="blogSearch" class="search-input" placeholder="Search posts...">
                    <button type="button" id="toggleShowBtn" class="toggle-show-btn">Hide All</button>
                </div>
                
                <div class="selection-controls">
                    <button type="button" id="selectAllBtn" class="selection-control-btn select-all">Select All</button>
                    <button type="button" id="deselectAllBtn" class="selection-control-btn deselect-all">Deselect All</button>
                </div>
                
                <div class="blogs-checkbox-container">
                    <div class="blogs-checkbox-grid" id="blogsGrid">
                        {% for blog_id, blog in blogs.items() %}
                        {% if blog and blog.title %}
                        <div class="blog-checkbox-item" data-blog-title="{{ blog.title|lower }}">
                            <input type="checkbox" id="blog_{{ blog_id }}" name="blog_ids" value="{{ blog_id }}" class="blog-checkbox">
                            <label for="blog_{{ blog_id }}" class="blog-checkbox-label">{{ blog.title }}</label>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Selected Posts Area -->
            <div class="selected-area" id="selectedArea" style="display: none;">
                <h3>Selected Posts <span class="selected-count">(0)</span></h3>
                <div class="selected-list-container">
                    <div class="selected-list" id="selectedList">
                        <!-- Selected blogs will appear here -->
                    </div>
                </div>
                
                <div class="group-selection">
                    <h4>Add to Group:</h4>
                    <div class="group-buttons" data-bulk-add-url="{{ url_for('add_multiple_blogs_to_group') }}">
                        {% for group_id, group in groups.items() %}
                        <button type="button" class="group-add-btn" data-group-id="{{ group_id }}">
                            {{ group.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Existing Groups -->
    <div class="groups-section">
        <div class="section-header">
            <h2>Existing Groups</h2>
            <span class="post-count">{{ groups|length }} groups</span>
        </div>

        {% if groups %}
        <div class="groups-grid">
            {% for group_id, group in groups.items() %}
            <div class="group-card">
                <div class="group-header">
                    <h3 class="group-name">{{ group.name }}</h3>
                    <span class="blog-count">{{ group.blogs|length }} posts</span>
                </div>
                
                {% if group.description %}
                <p class="group-description">{{ group.description }}</p>
                {% endif %}

                <!-- Add Blog to Group - Compact Vertical Layout -->
                <div class="add-to-group-compact">
                    <form method="POST" action="{{ url_for('add_blog_to_group') }}" class="compact-add-form">
                        <input type="hidden" name="group_id" value="{{ group_id }}">
                        <div class="compact-select-container">
                            <select name="blog_id" class="blog-select-compact" required>
                                <option value="">Select a blog...</option>
                                {% for blog_id, blog in blogs.items() %}
                                {% if blog and blog.title and blog_id not in group.blogs %}
                                <option value="{{ blog_id }}">{{ blog.title }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <button type="submit" class="action-btn add-compact">Add</button>
                        </div>
                    </form>
                </div>

                <!-- Blogs in this Group -->
<!-- Blogs in this Group -->
{% if group.blogs %}
<div class="group-blogs">
    <h4>Blogs in this group:</h4>
    <div class="blog-tags">
        {% for blog_id in group.blogs %}
        {% if blog_id in blogs and blogs[blog_id] and blogs[blog_id].title %}
        {% set blog = blogs[blog_id] %}
        <div class="blog-tag">
            <span>{{ blog.title }}</span>
            <form method="POST" action="{{ url_for('remove_blog_from_group') }}" class="inline-form">
                <input type="hidden" name="group_id" value="{{ group_id }}">
                <input type="hidden" name="blog_id" value="{{ blog_id }}">
                <button type="submit" class="remove-btn">&times;</button>
            </form>
        </div>
        {% else %}
        <!-- Show placeholder for missing blog -->
        <div class="blog-tag" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
            <span>Missing Blog (ID: {{ blog_id }})</span>
            <form method="POST" action="{{ url_for('remove_blog_from_group') }}" class="inline-form">
                <input type="hidden" name="group_id" value="{{ group_id }}">
                <input type="hidden" name="blog_id" value="{{ blog_id }}">
                <button type="submit" class="remove-btn">&times;</button>
            </form>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% else %}
<p class="no-blogs">No blogs in this group yet.</p>
{% endif %}

                <div class="card-actions">
                    <a href="{{ url_for('delete_group', group_id=group_id) }}" 
                       class="action-btn delete"
                       onclick="return confirm('Delete this group?')">
                        Delete Group
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìÅ</div>
            <h3>No groups yet</h3>
            <p>Create your first group to organize blog posts</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-----------JS Link------------------------>
{% block extra_js %}
<script src="{{ url_for('static', filename='js/manage_groups.js') }}"></script>
{% endblock %}